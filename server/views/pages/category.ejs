<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <%- include('../partials/header', { user }) %>

        <main class="container" style="padding-top: 4rem; padding-bottom: 4rem;">
            <div class="space-y-12">
                <div class="border-b border-slate-100 pb-8">
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
                        <%= categoryTitle %>
                    </h1>
                    <p class="mt-2 text-slate-500">Explore curated test series for your course. Quality practice for
                        better results.</p>
                </div>

                <% const freeTests=tests.filter(t=> !t.type || (t.type && t.type.toUpperCase() === 'FREE'));
                    const paidTests = tests.filter(t => t.type && t.type.toUpperCase() === 'PAID');
                    %>

                    <!-- FREE TESTS SECTION -->
                    <% if (freeTests.length> 0) { %>
                        <section>
                            <div class="flex items-center gap-3 mb-6">
                                <h2 class="text-2xl font-bold text-slate-900">Free Test Series</h2>
                                <span class="pill-outline text-[10px] uppercase tracking-wider">Start Today</span>
                            </div>
                            <div class="grid gap-6 md:grid-cols-3">
                                <% freeTests.forEach(function(test) { %>
                                    <div class="card flex flex-col p-6">
                                        <div class="flex justify-between items-start mb-4">
                                            <h3 class="font-bold text-slate-900 leading-tight">
                                                <%= test.title %>
                                            </h3>
                                            <span class="pill-outline"
                                                style="font-size: 0.65rem; padding: 0.2rem 0.6rem;">FREE</span>
                                        </div>
                                        <p class="text-xs text-slate-500 mb-6 line-clamp-2">
                                            <%= test.description || 'Access high-quality practice questions for free.'
                                                %>
                                        </p>
                                        <div class="mt-auto">
                                            <div
                                                class="flex gap-4 mb-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                                <span>‚è±Ô∏è <%= test.duration %> MIN</span>
                                                <span>üìù <%= test.questions.length %> QUES</span>
                                            </div>
                                            <div class="flex gap-2">
                                                <a href="/tests/<%= test._id %>" class="btn-primary flex-1">View
                                                    Details</a>
                                            </div>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>
                        </section>
                        <% } %>

                            <!-- PAID TESTS SECTION -->
                            <% if (paidTests.length> 0) { %>
                                <section>
                                    <div class="flex items-center gap-3 mb-6">
                                        <h2 class="text-2xl font-bold text-slate-900">Premium Series</h2>
                                        <span class="pill-danger text-[10px] uppercase tracking-wider"
                                            style="background: var(--primary);">Exclusive</span>
                                    </div>
                                    <div class="grid gap-6 md:grid-cols-3">
                                        <% paidTests.forEach(function(test) { %>
                                            <div class="card flex flex-col p-6"
                                                style="border-left: 4px solid var(--primary);">
                                                <div class="flex justify-between items-start mb-4">
                                                    <h3 class="font-bold text-slate-900 leading-tight">
                                                        <%= test.title %>
                                                    </h3>
                                                    <div class="flex flex-col items-end">
                                                        <span class="text-lg font-extrabold text-primary">‚Çπ<%=
                                                                test.price || 0 %></span>
                                                        <span
                                                            class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">PREMIUM</span>
                                                    </div>
                                                </div>
                                                <p class="text-xs text-slate-500 mb-6 line-clamp-2">
                                                    <%= test.description
                                                        || 'Deep-dive practice with expert-curated premium content.' %>
                                                </p>
                                                <div class="mt-auto">
                                                    <div
                                                        class="flex gap-4 mb-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                                        <span>‚è±Ô∏è <%= test.duration %> MIN</span>
                                                        <span>üìù <%= (test.questions && test.questions.length) || 0 %>
                                                                QUES</span>
                                                    </div>
                                                    <div class="flex gap-2">
                                                        <% if (purchasedTestIds.includes(test._id.toString())) { %>
                                                            <a href="/tests/<%= test._id %>"
                                                                class="btn-secondary flex-1">
                                                                View Test Series
                                                            </a>
                                                            <% } else { %>
                                                                <a href="javascript:void(0)" class="btn-primary flex-1"
                                                                    onclick="return confirmPaidAccess('<%= test._id %>', '<%= test.price %>', <%= user ? 'true' : 'false' %>, event)">
                                                                    Unlock Content
                                                                </a>
                                                                <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }) %>
                                    </div>
                                </section>
                                <% } %>

                                    <% if (tests.length===0) { %>
                                        <div class="card text-center py-20 bg-slate-50/50 border-dashed">
                                            <div class="text-5xl mb-6">üèùÔ∏è</div>
                                            <h3 class="text-xl font-bold text-slate-900">Nothing here yet</h3>
                                            <p class="text-slate-500 mt-2">New test series are being curated. Check back
                                                soon!</p>
                                        </div>
                                        <% } %>
            </div>
        </main>

        <script>
            async function purchaseTestAJAX(testId, price, buttonEl) {
                if (!confirm(`Purchase this test for ‚Çπ${price}?`)) {
                    return;
                }

                try {
                    const originalText = buttonEl.innerText;
                    buttonEl.innerText = 'Unlocking...';
                    buttonEl.disabled = true;

                    const res = await fetch(`/api/purchases/${testId}`, {
                        method: 'POST',
                        credentials: 'include',
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.message || 'Purchase failed');
                    }

                    // Success: Update UI without refresh
                    buttonEl.innerText = 'View Test Series';
                    buttonEl.classList.remove('btn-primary');
                    buttonEl.classList.add('btn-secondary'); // Or similar style
                    buttonEl.onclick = () => location.href = `/tests/${testId}`;
                    buttonEl.disabled = false;

                    alert('Test purchased successfully! You can now view the content.');
                } catch (err) {
                    console.error(err);
                    const msg = err.message.toLowerCase();
                    if (msg.includes('already purchased') || msg.includes('already exists')) {
                        // Success case: It's already yours!
                        buttonEl.innerText = 'View Test Series';
                        buttonEl.classList.remove('btn-primary');
                        buttonEl.classList.add('btn-secondary');
                        buttonEl.onclick = () => location.href = `/tests/${testId}`;
                        buttonEl.disabled = false;
                        return;
                    }
                    alert('Error: ' + err.message);
                    buttonEl.innerText = 'Unlock Content';
                    buttonEl.disabled = false;
                }
            }

            async function refreshPageState() {
                try {
                    const res = await fetch('/api/purchases', { credentials: 'include' });
                    if (!res.ok) return;
                    const purchases = await res.json();
                    const purchasedIds = purchases.map(p => (p.testId._id || p.testId).toString());

                    // Update all buttons on the page
                    document.querySelectorAll('[onclick*="confirmPaidAccess"]').forEach(btn => {
                        // Extract testId from onclick attribute
                        const match = btn.getAttribute('onclick').match(/'([^']+)'/);
                        if (match && purchasedIds.includes(match[1])) {
                            btn.innerText = 'View Test Series';
                            btn.className = 'btn-secondary flex-1';
                            btn.onclick = () => location.href = `/tests/${match[1]}`;
                            btn.removeAttribute('onclick'); // Important to stop the old handler
                        }
                    });

                    // Also update hero message if possible
                    // (Assuming we can find the user name via some other means or just skip for now)
                } catch (err) {
                    console.error('Failed to refresh page state:', err);
                }
            }
            window.refreshPageState = refreshPageState;

            function confirmPaidAccess(testId, price, isAuthenticated, event) {
                const buttonEl = event.currentTarget;
                if (!isAuthenticated) {
                    openAuthModal('login', () => purchaseTestAJAX(testId, price, buttonEl));
                    return false;
                }
                purchaseTestAJAX(testId, price, buttonEl);
                return false;
            }
        </script>

        <%- include('../partials/footer') %>
</body>

</html>